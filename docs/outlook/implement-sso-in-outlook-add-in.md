---
title: 'シナリオ: サービスにシングル サインオンを実装する'
description: Outlook アドインが提供するシングル サインオン トークンと Exchange ID トークンを使用して、サービスに SSO を実装する方法について説明します。
ms.date: 04/15/2019
localization_priority: Normal
ms.openlocfilehash: f1f8d4e844223e698d3db4ee0a16cf29b2355e1b
ms.sourcegitcommit: 7ef14753dce598a5804dad8802df7aaafe046da7
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/10/2020
ms.locfileid: "45093974"
---
# <a name="scenario-implement-single-sign-on-to-your-service-in-an-outlook-add-in"></a><span data-ttu-id="dc921-103">シナリオ: Outlook アドインでサービスにシングル サインオンを実装する</span><span class="sxs-lookup"><span data-stu-id="dc921-103">Scenario: Implement single sign-on to your service in an Outlook add-in</span></span>

<span data-ttu-id="dc921-104">この記事では、独自のバックエンド サービスにシングル サインオンの実装を提供するために、[シングル サインオン アクセス トークン](authenticate-a-user-with-an-sso-token.md)と [Exchange ID トークン](authenticate-a-user-with-an-identity-token.md)を同時に使用する推奨の方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="dc921-104">In this article we'll explore a recommended method of using the [single sign-on access token](authenticate-a-user-with-an-sso-token.md) and the [Exchange identity token](authenticate-a-user-with-an-identity-token.md) together to provide a single-sign on implementation to your own backend service.</span></span> <span data-ttu-id="dc921-105">両方のトークンを同時に使用することで、SSO アクセス トークンが使用できる場合はその利点を活用し、そのトークンが使用できない場合でもアドインが確実に動作するようにします。SSO アクセス トークンは、ユーザーがそのトークンをサポートしていないクライアントに切り替えたときや、ユーザーのメールボックスがオンプレミスの Exchange サーバーにある場合などは使用できません。</span><span class="sxs-lookup"><span data-stu-id="dc921-105">By using both tokens together, you can take advantage of the benefits of the SSO access token when it is available, while ensuring that your add-in will work when it is not, such as when the user switches to a client that does not support them, or if the user's mailbox is on an on-premises Exchange server.</span></span>


> [!NOTE]
> <span data-ttu-id="dc921-106">現在、シングル サインオン API は Word、Excel、Outlook、PowerPoint のプレビューでサポートされています。</span><span class="sxs-lookup"><span data-stu-id="dc921-106">The Single Sign-on API is currently supported in preview for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="dc921-107">シングル サインオン API の現在のサポート状態に関する詳細は、「[Identity API の要件セット](../reference/requirement-sets/identity-api-requirement-sets.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dc921-107">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](../reference/requirement-sets/identity-api-requirement-sets.md).</span></span>
> <span data-ttu-id="dc921-108">SSO を使用するには、アドインのスタートアップ HTML ページの https://appsforoffice.microsoft.com/lib/beta/hosted/office.js から Office JavaScript ライブラリのベータ版を読み込む必要があります。</span><span class="sxs-lookup"><span data-stu-id="dc921-108">To use SSO, you must load the beta version of the Office JavaScript Library from https://appsforoffice.microsoft.com/lib/beta/hosted/office.js in the startup HTML page of the add-in.</span></span>
> <span data-ttu-id="dc921-109">Outlook アドインで作業している場合は、Microsoft 365 テナントの先進認証を有効にしてください。</span><span class="sxs-lookup"><span data-stu-id="dc921-109">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Microsoft 365 tenancy.</span></span> <span data-ttu-id="dc921-110">この方法の詳細については、「[Exchange Online: テナントの先進認証を有効にする方法](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="dc921-110">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>


## <a name="why-use-the-sso-access-token"></a><span data-ttu-id="dc921-111">SSO アクセス トークンを使用する理由</span><span class="sxs-lookup"><span data-stu-id="dc921-111">Why use the SSO access token?</span></span>

<span data-ttu-id="dc921-112">Exchange ID トークンはアドインの API のすべての要件セットで使用できるため、このトークンだけを使用して、SSO トークンは完全に無視してしまうことがあります。</span><span class="sxs-lookup"><span data-stu-id="dc921-112">The Exchange identity token is available in all requirement sets of the add-in APIs, so it may be tempting to just rely on this token and ignore the SSO token altogether.</span></span> <span data-ttu-id="dc921-113">ただし、SSO トークンには Exchange ID トークンよりも優れた点がいくつかあるため、使用できるときには SSO トークンが推奨の方法になります。</span><span class="sxs-lookup"><span data-stu-id="dc921-113">However, the SSO token offers some advantages over the Exchange identity token which make it the recommended method to use when it is available.</span></span>

- <span data-ttu-id="dc921-114">SSO トークンは、標準の OpenID 形式を使用して、Azure が発行します。</span><span class="sxs-lookup"><span data-stu-id="dc921-114">The SSO token uses a standard OpenID format and is issued by Azure.</span></span> <span data-ttu-id="dc921-115">そのため、このトークンの検証プロセスは、とても簡単になります。</span><span class="sxs-lookup"><span data-stu-id="dc921-115">This greatly simplifies the process of validating these tokens.</span></span> <span data-ttu-id="dc921-116">それに比べて、Exchange ID トークンは JSON Web トークン標準に基づいたカスタム形式を使用するため、トークンの検証にカスタムの操作が必要になります。</span><span class="sxs-lookup"><span data-stu-id="dc921-116">In comparison, Exchange identity tokens use a custom format based on the JSON Web Token standard, requiring custom work to validate the token.</span></span>
- <span data-ttu-id="dc921-117">SSO トークンは、Microsoft Graph のトークンを取得するためにバックエンドで使用できます。このとき、ユーザーが追加のサインイン操作を実行する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="dc921-117">The SSO token can be used by your backend to retrieve an access token for Microsoft Graph without the user having to do any additional sign in action.</span></span>
- <span data-ttu-id="dc921-118">SSO トークンは、ユーザーの表示名など豊富な ID 情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="dc921-118">The SSO token provides richer identity information, such as the user's display name.</span></span>

## <a name="add-in-scenario"></a><span data-ttu-id="dc921-119">アドインのシナリオ</span><span class="sxs-lookup"><span data-stu-id="dc921-119">Add-in scenario</span></span>

<span data-ttu-id="dc921-120">この例では、アドイン UI およびスクリプト (HTML + JavaScript) の両方で構成されているアドインと、そのアドインで呼び出すバックエンド Web API について考えてみます。</span><span class="sxs-lookup"><span data-stu-id="dc921-120">For the purposes of this example, consider an add-in that consists of both the add-in UI and scripts (HTML + JavaScript) and a backend Web API that is called by the add-in.</span></span> <span data-ttu-id="dc921-121">バックエンド Web API は、[Microsoft Graph API](/graph/overview) と Contoso Data API (架空のサード パーティ製 API) の両方を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="dc921-121">The backend Web API makes calls both to the [Microsoft Graph API](/graph/overview) and the Contoso Data API, a fictional API created by a third party.</span></span> <span data-ttu-id="dc921-122">Microsoft Graph API と同じように、Contoso Data API も OAuth 認証を必要とします。</span><span class="sxs-lookup"><span data-stu-id="dc921-122">Like the Microsoft Graph API, the Contoso Data API requires OAuth authentication.</span></span> <span data-ttu-id="dc921-123">要件は、アクセス トークンの有効期限が切れるたびに バックエンド Web API がユーザーに資格情報を求めるダイアログを表示することなく、両方の API を呼び出せるようにすることです。</span><span class="sxs-lookup"><span data-stu-id="dc921-123">The requirement is that the backend Web API should be able to call both APIs without having to prompt the user for their credentials every time an access token expires.</span></span>

<span data-ttu-id="dc921-124">そのために、バックエンド API は、ユーザーに関するセキュリティで保護されたデータベースを作成します。</span><span class="sxs-lookup"><span data-stu-id="dc921-124">To do this, the backend API creates a secure database of users.</span></span> <span data-ttu-id="dc921-125">それぞれのユーザーごとに、このデータベース内のエントリが割り当てられます。バックエンドは、このデータベースに Microsoft Graph API と Contoso Data API の長期間有効な更新トークンを保存します。</span><span class="sxs-lookup"><span data-stu-id="dc921-125">Each user will get an entry in the database where the backend can store long-lived refresh tokens for both the Microsoft Graph API and the Contoso Data API.</span></span> <span data-ttu-id="dc921-126">次に示す JSON マークアップは、データベース内のユーザーのエントリを表しています。</span><span class="sxs-lookup"><span data-stu-id="dc921-126">The following JSON markup represents a user's entry in the database.</span></span>

```JSON
{
  "userDisplayName": "...",
  "ssoId": "...",
  "exchangeId": "...",
  "graphRefreshToken": "...",
  "contosoRefreshToken": "..."
}
```

<span data-ttu-id="dc921-127">アドインは、バックエンド Web API を呼び出すたびに、SSO アクセス トークン (使用可能な場合) または Exchange ID トークン (SSO トークンが使用不可の場合) のどちらかを含めます。</span><span class="sxs-lookup"><span data-stu-id="dc921-127">The add-in includes either the SSO access token (if it is available) or the Exchange identity token (if the SSO token is not available) with every call it makes to the backend Web API.</span></span>

### <a name="add-in-startup"></a><span data-ttu-id="dc921-128">アドインのスタートアップ</span><span class="sxs-lookup"><span data-stu-id="dc921-128">Add-in startup</span></span>

1. <span data-ttu-id="dc921-129">アドインの起動時に、アドインはバックエンド Web API に要求を送信して、ユーザーが登録されているかどうか (ユーザー データベースに関連付けられたレコードがあるか) と、その API が Graph および Contoso の更新トークンを保持しているかを判断します。</span><span class="sxs-lookup"><span data-stu-id="dc921-129">When the add-in starts, it sends a request to the backend Web API to determine if the user is registered (i.e. has an associated record in the user database) and that the API has refresh tokens for both Graph and Contoso.</span></span> <span data-ttu-id="dc921-130">アドインは、この呼び出に SSO トークン (使用可能な場合) と ID トークンの両方を含めます。</span><span class="sxs-lookup"><span data-stu-id="dc921-130">In this call, the add-in includes both the SSO token (if available) and the identity token.</span></span>

1. <span data-ttu-id="dc921-131">Web API は、「[Outlook アドインでシングル サインオン トークンを使用してユーザーを認証する](authenticate-a-user-with-an-sso-token.md)」と「[Exchange の ID トークンを使用してユーザーを認証する](authenticate-a-user-with-an-identity-token.md)」に示した方法を使用して、両方のトークンを検証して一意の ID を生成します。</span><span class="sxs-lookup"><span data-stu-id="dc921-131">The Web API uses the methods in [Authenticate a user with an single-sign-on token in an Outlook add-in](authenticate-a-user-with-an-sso-token.md) and [Authenticate a user with an identity token for Exchange](authenticate-a-user-with-an-identity-token.md) to validate and generate a unique identifier from both tokens.</span></span>

1. <span data-ttu-id="dc921-132">SSO トークンが提供された場合、Web API は SSO トークンから生成された一意の ID と一致する `ssoId` 値を保持するエントリについて、ユーザー データベースを照会します。</span><span class="sxs-lookup"><span data-stu-id="dc921-132">If an SSO token was provided, the Web API then queries the user database for an entry that has an `ssoId` value that matches the unique identifier generated from the SSO token.</span></span>
   - <span data-ttu-id="dc921-133">エントリが存在しない場合は、次の手順に進みます。</span><span class="sxs-lookup"><span data-stu-id="dc921-133">If an entry did not exist, continue to the next step.</span></span>
   - <span data-ttu-id="dc921-134">エントリが存在する場合は、手順 5 に進みます。</span><span class="sxs-lookup"><span data-stu-id="dc921-134">If an entry exists, proceed to step 5.</span></span>

1. <span data-ttu-id="dc921-135">Web API は、Exchange ID トークンから生成された一意の ID と一致する `exchangeId` 値を保持するエントリについて、データベースを照会します。</span><span class="sxs-lookup"><span data-stu-id="dc921-135">The Web API queries the database for an entry that has an `exchangeId` value that matches the unique identifier generated from the Exchange identity token.</span></span>
   - <span data-ttu-id="dc921-136">エントリが存在しているときに、SSO トークンが提供されていた場合は、データベース内のユーザーのレコードを更新して、`ssoId` の値を SSO トークンから生成された一意の ID に設定して、手順 5 に進みます。</span><span class="sxs-lookup"><span data-stu-id="dc921-136">If an entry exists and an SSO token was provided, update the user's record in the database to set the `ssoId` value to the unique identifier generated from the SSO token and proceed to step 5.</span></span>
   - <span data-ttu-id="dc921-137">エントリが存在しているときに、SSO トークンが提供されていなかった場合は、手順 5 に進みます。</span><span class="sxs-lookup"><span data-stu-id="dc921-137">If an entry exists and no SSO token was provided, proceed to step 5.</span></span>
   - <span data-ttu-id="dc921-138">エントリが存在しないときには、新しいエントリを作成します。</span><span class="sxs-lookup"><span data-stu-id="dc921-138">If no entry exists, create a new entry.</span></span> <span data-ttu-id="dc921-139">`ssoId` を SSO トークン (使用可能な場合) から生成された一意の ID に設定し、`exchangeId` を Exchange ID トークンから生成された一意の ID に設定します。</span><span class="sxs-lookup"><span data-stu-id="dc921-139">Set `ssoId` to the unique identifier generated from the SSO token (if available), and set `exchangeId` to the unique identifier generated from the Exchange identity token.</span></span>

1. <span data-ttu-id="dc921-140">ユーザーの `graphRefreshToken` 値で有効な更新トークンについて調べます。</span><span class="sxs-lookup"><span data-stu-id="dc921-140">Check for a valid refresh token in the user's `graphRefreshToken` value.</span></span>
   - <span data-ttu-id="dc921-141">この値が無効または見つからないときに、SSO トークンが提供されていた場合は、[OAuth2 On-Behalf-Of フロー](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of)を使用して Graph のアクセス トークンと更新トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="dc921-141">If the value is missing or invalid and an SSO token was provided, use the [OAuth2 On-Behalf-Of flow](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of) to obtain an access token and refresh token for Graph.</span></span> <span data-ttu-id="dc921-142">ユーザーの `graphRefreshToken` 値に更新トークンを保存します。</span><span class="sxs-lookup"><span data-stu-id="dc921-142">Save the refresh token in the `graphRefreshToken` value for the user.</span></span>

1. <span data-ttu-id="dc921-143">`graphRefreshToken` と `contosoRefreshToken` の両方で有効な更新トークンについて調べます。</span><span class="sxs-lookup"><span data-stu-id="dc921-143">Check for valid refresh tokens in both `graphRefreshToken` and `contosoRefreshToken`.</span></span>
   - <span data-ttu-id="dc921-144">両方の値が有効な場合は、ユーザーが既に登録および構成されていることを示す応答をアドインに返します。</span><span class="sxs-lookup"><span data-stu-id="dc921-144">If both values are valid, respond to the add-in to indicate that the user is already registered and configured.</span></span>
   - <span data-ttu-id="dc921-145">どちらかの値が無効な場合は、ユーザーの設定が必要なことと、構成が必要になるサービスがどちらか (Graph または Contoso) を示す応答をアドインに返します。</span><span class="sxs-lookup"><span data-stu-id="dc921-145">If either value is invalid, respond to the add-in to indicate that user setup is required, along with which services (Graph or Contoso) need to be configured.</span></span>

1. <span data-ttu-id="dc921-146">アドインは、この応答を確認します。</span><span class="sxs-lookup"><span data-stu-id="dc921-146">The add-in checks the response.</span></span>
   - <span data-ttu-id="dc921-147">ユーザーが既に登録および構成されている場合、アドインは通常の操作を続行します。</span><span class="sxs-lookup"><span data-stu-id="dc921-147">If the user is already registered and configured, the add-in continues with normal operation.</span></span>
   - <span data-ttu-id="dc921-148">ユーザーの設定が必要な場合、アドインは「セットアップ」モードに移行して、ユーザーにアドインを承認するように求めるダイアログを表示します。</span><span class="sxs-lookup"><span data-stu-id="dc921-148">If user setup is required, the add-in enters "setup" mode and prompts the user to authorize the add-in.</span></span>

### <a name="authorize-the-backend-web-api"></a><span data-ttu-id="dc921-149">バックエンド Web API の承認</span><span class="sxs-lookup"><span data-stu-id="dc921-149">Authorize the backend Web API</span></span>

<span data-ttu-id="dc921-150">Microsoft Graph API と Contoso Data API を呼び出すバックエンド Web API を承認する手順は、1 回だけ実施されるようにすることが理想的です。そうすることで、ユーザーにサインインを求めるダイアログの表示を最小限に抑えるようにします。</span><span class="sxs-lookup"><span data-stu-id="dc921-150">The procedure for authorizing the backend Web API to call the Microsoft Graph API and Contoso Data API should ideally only have to happen once, to minimize having to prompt the user for sign-in.</span></span>

<span data-ttu-id="dc921-151">バックエンド Web API からの応答に基づいて、アドインは Microsoft Graph API または Contoso Data API、またはその両方のユーザーを承認することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="dc921-151">Based on the response from the backend Web API, the add-in may need to authorize the user for the Microsoft Graph API, the Contoso Data API, or both.</span></span> <span data-ttu-id="dc921-152">どちらの API も OAuth2 認証を使用するため、その方法はどちらも同様になります。</span><span class="sxs-lookup"><span data-stu-id="dc921-152">Since both APIs use OAuth2 authentication, the method is similar for both.</span></span>

1. <span data-ttu-id="dc921-153">アドインは、API の使用を承認する必要があることをユーザーに通知して、そのプロセスを開始するためにリンクまたはボタンをクリックするように求めます。</span><span class="sxs-lookup"><span data-stu-id="dc921-153">The add-in notifies the user that it needs them to authorize their use of the API and asks them to click a link or button to start the process.</span></span>

1. <span data-ttu-id="dc921-154">アドインは、[ダイアログ API](/javascript/api/office/office.ui#displaydialogasync-startaddress--options--callback-) または [office-js-helpers ライブラリ](https://github.com/OfficeDev/office-js-helpers)を使用して、API の [OAuth2 認証コード フロー](/azure/active-directory/develop/active-directory-protocols-oauth-code)を開始します。</span><span class="sxs-lookup"><span data-stu-id="dc921-154">The add-in uses the [Dialog API](/javascript/api/office/office.ui#displaydialogasync-startaddress--options--callback-) or the [office-js-helpers library](https://github.com/OfficeDev/office-js-helpers) to start the [OAuth2 Authorization Code flow](/azure/active-directory/develop/active-directory-protocols-oauth-code) for the API.</span></span>

1. <span data-ttu-id="dc921-155">このフローが完了すると、アドインは更新トークンをバックエンド Web API に送信し、SSO トークン (使用可能な場合) または Exchange ID トークンを含めます。</span><span class="sxs-lookup"><span data-stu-id="dc921-155">Once the flow completes, the add-in sends the refresh token to the backend Web API and includes the SSO token (if available) or the Exchange identity token.</span></span>

1. <span data-ttu-id="dc921-156">バックエンド Web API はデータベース内でユーザーを見つけて、該当する更新トークンを更新します。</span><span class="sxs-lookup"><span data-stu-id="dc921-156">The backend Web API locates the user in the database and updates the appropriate refresh token.</span></span>

1. <span data-ttu-id="dc921-157">アドインは、通常の操作を続行します。</span><span class="sxs-lookup"><span data-stu-id="dc921-157">The add-in continues with normal operation.</span></span>

### <a name="normal-operation"></a><span data-ttu-id="dc921-158">通常の操作</span><span class="sxs-lookup"><span data-stu-id="dc921-158">Normal operation</span></span>

<span data-ttu-id="dc921-159">アドインがバックエンド Web API を呼び出すときには、SSO トークンまたは Exchange ID トークンを必ず含めます。</span><span class="sxs-lookup"><span data-stu-id="dc921-159">Whenever the add-in calls the backend Web API, it includes either the SSO token or the Exchange identity token.</span></span> <span data-ttu-id="dc921-160">バックエンド Web API は、このトークンでユーザーを見つけて、保存されている更新トークンを使用して Microsoft Graph API と Contoso Data API のアクセス トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="dc921-160">The backend Web API locates the user by this token, then uses the stored refresh tokens to obtain access tokens for the Microsoft Graph API and the Contoso Data API.</span></span> <span data-ttu-id="dc921-161">更新トークンが有効な間、ユーザーは再度サインインする必要がなくなります。</span><span class="sxs-lookup"><span data-stu-id="dc921-161">As long as the refresh tokens are valid, the user will not have to sign in again.</span></span>
