---
title: Office Dialog API を使用して認証および承認する
description: ''
ms.date: 08/07/2019
localization_priority: Priority
ms.openlocfilehash: 3d61c82f28fd5780176b356e1ab4d394e5fbf8bd
ms.sourcegitcommit: 1dc1bb0befe06d19b587961da892434bd0512fb5
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2019
ms.locfileid: "36302959"
---
# <a name="authenticate-and-authorize-with-the-office-dialog-api"></a>Office Dialog API を使用して認証および承認する

> [!NOTE]
> この記事は、[Office アドインでのダイアログ API の使用](dialog-api-in-office-add-ins.md)に慣れていることを前提としています。

Secure Token Services (STS) とも呼ばれる多くの ID 機関は、ログイン ページが iframe で開かないようにします。 これらの機能には、Microsoft アカウントと Office 365 (職場または学校のアカウント) などの Microsoft ID プラットフォーム (以前の Azure AD V 2.0) に保護されている Google、Facebook、およびサービスが含まれます。 これにより、アドインが **Office on the web** で実行されており、作業ウィンドウが iframe の場合に、Office アドインに問題が発生します。 アドインで完全に独立したブラウザー インスタンスを開くことができる場合に、アドインのユーザーはこれらのいずれかのサービスにのみログインできます。 Office には[ダイアログ API](dialog-api-in-office-add-ins.md)、特に [displayDialogAsync](/javascript/api/office/office.ui) メソッドが用意されているためです。

この API が表示されるダイアログ ボックスには、次の特徴があります。

- [非モーダル](https://en.wikipedia.org/wiki/Dialog_box)です。
- 次のような、作業ウィンドウと完全に独立したブラウザー インスタンスです。
  - これには、独自の JavaScript ランタイム環境およびウィンドウ オブジェクトとグローバル変数があります。
  - 作業ウィンドウと共有されている実行環境はありません。
  - 作業ウィンドウと同じセッション ストレージは共有されません。
- ダイアログ ボックスで開いた最初のページは、プロトコル、サブドメイン、ポートなどがあれば、作業ウィンドウと同じドメインにホストされている必要があります。
- このダイアログ ボックスでは、[messageparent](/javascript/api/office/office.ui#messageparent-message-) メソッドを使用して作業ウィンドウに情報を返すことができますが、このメソッドは、プロトコル、サブドメイン、ポートなどの作業ウィンドウと同じドメインにホストされているページからのみ呼び出すことができます。

ダイアログが iframe (既定) ではない場合、ID プロバイダーのログイン ページを開くことができます。 次に示すように、ダイアログの特徴は、MSAL や Passport などの認証または承認ライブラリの使用方法に影響します。

> [!NOTE]
> `displayDialogAsync` への呼び出しで単に `displayInIframe: true` オプションを渡すといった浮動 iframe で開くようダイアログを設定する方法があります。 ログインにダイアログ API を使用している場合は、この操作を*行わないでください*。

## <a name="authentication-flow-with-the-dialog"></a>ダイアログを使用した認証フロー

次に、シンプルで標準的な認証フローを示します。 詳細は図表の後にあります。

![作業ウィンドウとダイアログ ブラウザーのプロセスの関係を示す画像。](../images/taskpane-dialog-processes.gif)

1. ダイアログ ボックスで開く最初のページは、アドインのドメイン (つまり作業ウィンドウと同じドメイン) でホストされるページ (または他のリソース) です。 このページには、"*NAME-OF-PROVIDER* にサインインが可能なページにリダイレクトしていますので、お待ちください。" という簡単な UI を含めることができます。 「[情報をダイアログ ボックスに渡す](dialog-api-in-office-add-ins.md#pass-information-to-the-dialog-box)」に記載されているように、このページのコードは、ダイアログ ボックスに渡される情報、または web.config ファイルのようなアドインの構成ファイルにハードコーディングされている情報を使用して、ID プロバイダーのサインイン ページの URL を構築します。
2. 次に、ダイアログ ウィンドウがサインイン ページにリダイレクトされます。 URL には、ユーザーがサインインしたらダイアログ ウィンドウを特定のページにリダイレクトするように ID プロバイダーに指示するクエリ パラメーターが含まれています。 この記事では、このページを **redirectPage.html** と呼びます。 *ホスト ウィンドウと同じドメイン内のページにする必要があるため*、サインインを試行した結果を、`messageParent`を呼び出した作業ウィンドウに渡すことができます。
3. ID プロバイダーのサービスは、ダイアログ ウィンドウの着信 GET 要求を処理します。 ユーザーが既にサインインしている場合は、直ちにウィンドウを **redirectPage.html** にリダイレクトして、ユーザー データをクエリ パラメーターとして含めます。 ユーザーがまだサインインしていない場合は、プロバイダーのサインイン ページがウィンドウに表示され、ユーザーがサインインします。 ほとんどのプロバイダーでは、ユーザーが正常にサインインできない場合、プロバイダーはダイアログ ウィンドウにエラー ページを表示して、**redirectPage.html** にはリダイレクトしません。 ユーザーは隅にある **X** を選択して、ウィンドウを閉じる必要があります。 ユーザーが正常にサインインした場合は、ダイアログ ウィンドウが **redirectPage.html** にリダイレクトされ、ユーザー データがクエリ パラメーターとして含まれます。
4. **redirectPage.html** ページが開くと、`messageParent` を呼び出して、成功または失敗を作業ウィンドウ ページに報告し、また必要に応じて、ユーザー データまたはエラー データも報告します。 その他のメッセージには、アクセス トークンの受け渡しや、トークンがストレージにあるという作業ウィンドウへの伝達が含まれます。
5. `DialogMessageReceived` イベントが作業ウィンドウ ページで発生し、そのハンドラーはダイアログ ウィンドウを閉じ、メッセージをさらに処理できます。

#### <a name="support-multiple-identity-providers"></a>複数の ID プロバイダーのサポート

アドインによってユーザーが Microsoft アカウント、Google、Facebook などのプロバイダーを選択できる場合は、ユーザーがプロバイダーを選択するための UI を提供するローカルの最初のページ (前述のセクションを参照) が必要です。選択すると、サインイン URL とその URL へのリダイレクトの構築がトリガーされます。

#### <a name="authorization-of-the-add-in-to-an-external-resource"></a>外部リソースへのアドインの承認

最新の Web において、ユーザーと Web アプリケーションはセキュリティ プリンシパルです。 アプリケーションには Office 365、Google+、Facebook、LinkedIn などのオンライン リソースに対する独自の ID とアクセス許可があります。 アプリケーションは、展開前にリソース プロバイダーに登録されます。 登録には以下が含まれています。

- アプリケーションが必要とするアクセス許可の一覧。
- アプリケーションがサービスにアクセスするときに、リソース サービスがアクセス トークンを返す宛先の URL。  

リソース サービスのユーザーのデータにアクセスするアプリケーションでユーザーが関数を呼び出すと、ユーザーはサービスにサインインするように求められ、アプリケーションが必要とするユーザーのリソースへのアクセス許可をアプリケーションに付与するように求められます。次に、サービスはサインイン ウィンドウを既に登録済みの URL にリダイレクトし、アクセス トークンを渡します。アプリケーションはアクセス トークンを使用して、ユーザーのリソースにアクセスします。

ユーザーのサインイン用に示されているフローと類似したフローを使用すると、ダイアログ API を使用してこのプロセスを管理できます。 違いは次のとおりです。

- アプリケーションが必要とするアクセス許可を、ユーザーがアプリケーションに付与したことがない場合は、サインインすると、ユーザーに対してこれを実行するよう求めるメッセージがダイアログ ボックスに表示されます。
- ダイアログ ウィンドウは、`messageParent` を使用して文字列に変換されたアクセス トークンを送信するか、またはホスト ウィンドウがアクセス トークンを取得できる場所にアクセス トークンを格納 (してトークンが使用可能であることをホスト ウィンドウに伝達する `messageParent` を使用)することで、アクセス トークンをホスト ウィンドウに送信します。 トークンには制限時間がありますが、制限時間内であれば追加のメッセージを表示することなく、ホスト ウィンドウはトークンを使用して、ユーザーのリソースに直接アクセスできます。

この目的のためにダイアログ API を使う一部の認証サンプル アドインは、[サンプル](#samples)に記載されています。

## <a name="using-authentication-libraries-with-the-dialog"></a>ダイアログでの認証ライブラリの使用

Office ダイアログと作業ウィンドウが異なるブラウザーおよび JavaScript ランタイムで実行されるという事実は、認証と承認が同じウィンドウで行われる場合の使用方法とは異なる方法で、多くの認証または承認ライブラリを使用する必要があるということです。 次のセクションでは、通常これらのライブラリを使用しない主な方法と、これらのライブラリを使用*する*方法について説明します。

### <a name="you-usually-cannot-use-the-librarys-internal-cache-to-store-tokens"></a>通常、トークンを格納するのにライブラリの内部キャッシュは使用できません。

通常、認証関連のライブラリには、アクセス トークンを格納するメモリ内のキャッシュが用意されています。 その後に、(Google、Microsoft Graph、Facebook などの) リソース プロバイダーを呼び出すと、ライブラリは最初にキャッシュ内のトークンの有効期限が切れているかどうかを確認します。 期限が切れている場合、ライブラリは新しいトークンの STS に別のラウンドトリップを行うのではなく、キャッシュされたトークンを返します。 ただし、このパターンは Office アドインでは使用できません。ログインは Office ダイアログのブラウザー インスタンスで発生するため、トークン キャッシュはそのインスタンスにあります。

これに密接に関連するのは、ライブラリが通常、トークンを取得するための対話型のメソッドと "silent" メソッドの両方を用意しているという事実です。 同じブラウザー インスタンスのリソースに対して認証とデータの呼び出しの両方を行うことができる場合は、コードが silent メソッドを呼び出して、トークンをデータの呼び出しに追加する直前にトークンを取得します。 silent メソッドがキャッシュの期限切れのトークンを確認し、期限切れのトークンがある場合は返します。 それ以外の場合、silent メソッドは対話型のメソッドを呼び出して、STS のログインにリダイレクトします。 ログインが完了すると、対話型のメソッドはトークンを返しますが、メモリにもキャッシュします。 ただし、Office ダイアログ API を使用している場合は、リソースへのデータ呼び出し (silent メソッドの呼び出し) は、作業ウィンドウのブラウザー インスタンスにあります。 ライブラリのトークン キャッシュはそのインスタンスに存在しません。

別の方法として、アドインのダイアログ ブラウザー インスタンスで、ライブラリの対話型のメソッドを直接呼び出すことができます。 このメソッドがトークンを返す場合、作業ウィンドウのブラウザー インスタンスは、ローカル ストレージやサーバー側のデータベースなどトークンを取得できる場所に、コードでトークンを明示的に格納する必要があります。 別の方法としては、`messageParent` メソッドを使用してトークンを作業ウィンドウに渡すことです。 この方法は、対話型のメソッドがコードで読み取ることができる場所にアクセス トークンを保存している場合にのみ可能です。 ライブラリの対話型メソッドは、コードにアクセスできないオブジェクトのプライベート プロパティのトークンを格納するように設計されている場合があります。

### <a name="you-usually-cannot-use-the-librarys-auth-context-object"></a>通常、ライブラリの "認証コンテキスト" オブジェクトは使用できません。

多くの場合、認証関連のライブラリには、トークンを対話的に取得する方法と、メソッドが返す "認証コンテキスト" オブジェクトを作成する方法もあります。 トークンはオブジェクトのプロパティです (プライベートであっても、コードから直接アクセスできない可能性があります)。 そのオブジェクトには、リソースからデータを取得する方法があります。 これには、(Google、Microsoft Graph、Facebook などの) リソースプロバイダーに対して行う HTTP 要求にトークンが含まれています。

この認証コンテキスト オブジェクトと、このオブジェクトの作成方法は、Office アドインでは使用できません。ログインは Office ダイアログのブラウザー インスタンスで発生するため、オブジェクトを作成する必要があります。 ただし、リソースへのデータの呼び出しは、作業ウィンドウのブラウザー インスタンスにあり、あるインスタンスから別のインスタンスにオブジェクトを取得する方法はありません。 たとえば、`messageParent` は文字列またはブール値のみを渡すことができるため、`messageParent` ではオブジェクトを渡すことはできません。 メソッドのある JavaScript オブジェクトを確実には変換できません。

### <a name="how-you-can-use-libraries-with-the-office-dialog-api"></a>Office ダイアログ API でライブラリを使用する方法

さらに、モノリシックの "認証コンテキスト" オブジェクトの代わりに、ほとんどのライブラリには、コードにより比較的モノリシックではないヘルパー オブジェクトを作成するできるようにする、抽象化レベルの低い API が用意されています。 たとえば、[MSAL.NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki#conceptual-documentation) v があります。 3.x.x にはログイン URL を構築する API があり、コードにアクセス可能なプロパティにアクセス トークンがある AuthResult オブジェクトを構築する別の API を使用します。 Office アドインの MSAL.NET の例については、「[Office アドイン Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET)」と「[Outlook アドイン Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET)」を参照してください。

認証および承認ライブラリの詳細については、「[Microsoft Graph: 推奨されるライブラリ](authorize-to-microsoft-graph-without-sso.md#recommended-libraries-and-samples)」と「[その他の外部サービス: ライブラリ](auth-external-add-ins.md#libraries)」を参照してください。

## <a name="samples"></a>サンプル

- [Office アドイン Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Office-Add-in-Microsoft-Graph-ASPNET): MSAL.NET ライブラリを使用して Microsoft Graph データのアクセス トークンを取得する ASP.NET ベースのアドイン (Excel、Word、PowerPoint)。
- [Outlook アドイン Microsoft Graph ASP.NET](https://github.com/OfficeDev/PnP-OfficeAddins/tree/master/Samples/auth/Outlook-Add-in-Microsoft-Graph-ASPNET): 上記と同様に、Office アプリケーションは Outlook です。

詳細については、次のトピックを参照してください。
- [Office アドインで外部サービスを承認する](auth-external-add-ins.md)
- [Office アドインでダイアログ API を使用する](dialog-api-in-office-add-ins.md)

