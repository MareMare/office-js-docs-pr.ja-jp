---
title: SSO を使用した Microsoft Graph への承認
description: Office アドインのユーザーがシングルサインオン (SSO) を使用して Microsoft Graph からデータを取得する方法について説明します。
ms.date: 01/14/2020
localization_priority: Normal
ms.openlocfilehash: 58b27e4549b4d31889e0e03ff8591fb3bdd7a7c0
ms.sourcegitcommit: fa4e81fcf41b1c39d5516edf078f3ffdbd4a3997
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/17/2020
ms.locfileid: "42719085"
---
# <a name="authorize-to-microsoft-graph-with-sso-preview"></a><span data-ttu-id="bb7e8-103">SSO を使用した Microsoft Graph への承認 (プレビュー)</span><span class="sxs-lookup"><span data-stu-id="bb7e8-103">Authorize to Microsoft Graph with SSO (preview)</span></span>

<span data-ttu-id="bb7e8-104">ユーザーは個人用の Microsoft アカウントまたは職場や学校の (Office 365) アカウントのいずれかを使用して、Office (オンライン、モバイル、およびデスクトップ プラットフォーム) にサインインします。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-104">Users sign in to Office (online, mobile, and desktop platforms) using either their personal Microsoft account or their work or school (Office 365) account.</span></span> <span data-ttu-id="bb7e8-105">Office アドインの [Microsoft Graph](https://developer.microsoft.com/graph/docs) へのアクセスの承認には、ユーザーの Office サインオン資格証明を使用するのが最良の方法です。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-105">The best way for an Office Add-in to get authorized access to [Microsoft Graph](https://developer.microsoft.com/graph/docs) is to use the credentials from the user's Office sign on.</span></span> <span data-ttu-id="bb7e8-106">これにより、2 回目はサインインする必要なく Microsoft Graph データにアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-106">This enables them to access their Microsoft Graph data without needing to sign in a second time.</span></span> 

> [!NOTE]
> <span data-ttu-id="bb7e8-p102">現在、シングル サインオン API は Word、Excel、Outlook、PowerPoint のプレビューでサポートされています。 シングル サインオン API の現在のサポート状態に関する詳細は、「[IdentityAPI の要件セット](../reference/requirement-sets/identity-api-requirement-sets.md)」を参照してください。 Outlook アドインで作業している場合は、Office 365 テナントの先進認証が有効になっていることを確認してください。 この方法の詳細については、「[Exchange Online: テナントの先進認証を有効にする方法](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-p102">The Single Sign-on API is currently supported in preview for Word, Excel, Outlook, and PowerPoint. For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](../reference/requirement-sets/identity-api-requirement-sets.md). If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Office 365 tenancy. For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a><span data-ttu-id="bb7e8-111">SSO と Microsoft Graph のアドイン アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="bb7e8-111">Add-in architecture for SSO and Microsoft Graph</span></span>

<span data-ttu-id="bb7e8-112">Web アプリケーションのページと JavaScript をホスティングすることに加え、アドインでは、同一の[完全修飾ドメイン名](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly)で、Microsoft Graph へのアクセス トークンを取得して、要求を送信するための 1 つ以上の Web API をホストする必要もあります。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-112">In addition to hosting the pages and JavaScript of the web application, the add-in must also host, at the same [fully qualified domain name](/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly), one or more web APIs that will get an access token to Microsoft Graph and make requests to it.</span></span>

<span data-ttu-id="bb7e8-113">アドイン マニフェストには、アドインを Azure Active Directory (Azure AD) v2.0 エンドポイントに登録する方法と、アドインが必要とする Microsoft Graph へのアクセス許可を指定するマークアップが含まれています。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-113">The add-in manifest contains markup that specifies how the add-in is registered in the Azure Active Directory (Azure AD) v2.0 endpoint, and it specifies any permissions to Microsoft Graph that the add-in needs.</span></span>

### <a name="how-it-works-at-runtime"></a><span data-ttu-id="bb7e8-114">実行時の動作のしくみ</span><span class="sxs-lookup"><span data-stu-id="bb7e8-114">How it works at runtime</span></span>

<span data-ttu-id="bb7e8-115">次の図は、Microsoft Graph へのサインインおよびアクセスの処理がどのように行われるのかを示しています。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-115">The following diagram shows how the process of signing in and getting access to Microsoft Graph works.</span></span>

![SSO プロセスを示す図](../images/sso-access-to-microsoft-graph.png)

1. <span data-ttu-id="bb7e8-117">アドインで、JavaScript は新しい Office.js API [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-) を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-117">In the add-in, JavaScript calls a new Office.js API [getAccessToken](/javascript/api/office-runtime/officeruntime.auth#getaccesstoken-options-).</span></span> <span data-ttu-id="bb7e8-118">これにより、Office ホスト アプリケーションはアドインへのアクセス トークンを取得するように指示されます </span><span class="sxs-lookup"><span data-stu-id="bb7e8-118">This tells the Office host application to obtain an access token to the add-in.</span></span> <span data-ttu-id="bb7e8-119">(これは処理の後半で 2 つ目のトークンと置換されるので、これ以降では**ブートストラップ アクセス トークン**と呼びます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-119">(Hereafter, this is called the **bootstrap access token** because it is replaced with a second token later in the process.</span></span> <span data-ttu-id="bb7e8-120">デコードされたブートストラップ アクセス トークンの例については、[アクセス トークンの例](sso-in-office-add-ins.md#example-access-token)に関するページを参照してください)。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-120">For an example of a decoded bootstrap access token, see [Example access token](sso-in-office-add-ins.md#example-access-token).)</span></span>
2. <span data-ttu-id="bb7e8-121">ユーザーがサインインしていない場合、ユーザーにサインインを求めるポップアップ ウィンドウが Office ホスト アプリケーションによって開かれます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-121">If the user is not signed in, the Office host application opens a pop-up window for the user to sign in.</span></span>
3. <span data-ttu-id="bb7e8-122">現在のユーザーが初めてアドインを使用する場合は、そのユーザーに同意を求めるダイアログが表示されます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-122">If this is the first time the current user has used your add-in, he or she is prompted to consent.</span></span>
4. <span data-ttu-id="bb7e8-123">Office ホスト アプリケーションは、Azure AD v2.0 エンドポイントから現在のユーザーの**ブートストラップ アクセス トークン**を要求します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-123">The Office host application requests the **bootstrap access token** from the Azure AD v2.0 endpoint for the current user.</span></span>
5. <span data-ttu-id="bb7e8-124">Azure AD が、Office ホスト アプリケーションにブートストラップ アクセス トークンを送信します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-124">Azure AD sends the bootstrap token to the Office host application.</span></span>
6. <span data-ttu-id="bb7e8-125">Office ホスト アプリケーションが、`getAccessToken` 呼び出しによって返される結果オブジェクトの一部として、アドインに**ブートストラップ アクセス トークン**を送信します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-125">The Office host application sends the **bootstrap access token** to the add-in as part of the result object returned by the `getAccessToken` call.</span></span>
7. <span data-ttu-id="bb7e8-126">アドインの JavaScript は、アドインと同じ完全修飾ドメイン名でホストされている Web API に HTTP 要求を送信して、その要求に承認の証拠として**ブートストラップ アクセス トークン**を含めます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-126">JavaScript in the add-in makes an HTTP request to a web API that is hosted at the same fully-qualified domain as the add-in, and it includes the **bootstrap access token** as authorization proof.</span></span>
8. <span data-ttu-id="bb7e8-127">受け取った**ブートストラップ アクセス トークン**はサーバー側のコードで検証されます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-127">Server-side code validates the incoming **bootstrap access token**.</span></span>
9. <span data-ttu-id="bb7e8-128">サーバー側のコードでは、"代理として定義される" フロー ( [OAuth2 Token Exchange](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) 、[デーモンまたはサーバーアプリケーションから web API Azure シナリオ](/azure/active-directory/develop/active-directory-authentication-scenarios)) を使用して、ブートストラップアクセストークンの Exchange で Microsoft Graph のアクセストークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-128">Server-side code uses the "on behalf of" flow (defined at [OAuth2 Token Exchange](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) and the [daemon or server application to web API Azure scenario](/azure/active-directory/develop/active-directory-authentication-scenarios)) to obtain an access token for Microsoft Graph in exchange for the bootstrap access token.</span></span>
10. <span data-ttu-id="bb7e8-129">Azure AD は、アドインに Microsoft Graph へのアクセス トークンを返します (アドインが *offline_access* アクセス許可を要求した場合は、更新トークンも返します)。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-129">Azure AD returns the access token to Microsoft Graph (and a refresh token, if the add-in requests *offline_access* permission) to the add-in.</span></span>
11. <span data-ttu-id="bb7e8-130">サーバー側のコードが Microsoft Graph へのアクセス トークンをキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-130">Server-side code caches the access token to Microsoft Graph.</span></span>
12. <span data-ttu-id="bb7e8-131">サーバー側のコードが Microsoft Graph に要求を送信します。そのコードには、Microsoft Graph へのアクセス トークンを含めます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-131">Server-side code makes requests to Microsoft Graph and includes the access token to Microsoft Graph.</span></span>
13. <span data-ttu-id="bb7e8-132">Microsoft Graph は、アドインの UI に渡すことができるデータをアドインに返します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-132">Microsoft Graph returns data to the add-in, which can pass it on to the add-in's UI.</span></span>
14. <span data-ttu-id="bb7e8-133">Microsoft Graph へのアクセス トークンの期限が切れた場合、サーバー側のコードがその更新トークンを使用して、Microsoft Graph への新しいアクセス トークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-133">When the access token to Microsoft Graph expires, the server-side code can use its refresh token to get a new access token to Microsoft Graph.</span></span>

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a><span data-ttu-id="bb7e8-134">Microsoft Graph にアクセスする SSO を開発する</span><span class="sxs-lookup"><span data-stu-id="bb7e8-134">Develop an SSO add-in that accesses Microsoft Graph</span></span>

<span data-ttu-id="bb7e8-135">Microsoft Graph にアクセスするアドインは、SSO を使用する他のすべてのアドインと同様に開発できます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-135">You develop an add-in that accesses Microsoft Graph just as you would any other add-in that uses SSO.</span></span> <span data-ttu-id="bb7e8-136">完全な説明については、「[Office アドインのシングル サインオンを有効化する](../develop/sso-in-office-add-ins.md)」を参照してください。違いは、アドインにサーバー側の Web API があることが必須であることと、この記事でアクセス トークンと呼ばれているものは “ブートストラップ アクセス トークン” と呼ばれているという点です。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-136">For a thorough description, see [Enable single sign-on for Office Add-ins](../develop/sso-in-office-add-ins.md). The difference is that it is mandatory that the add-in have a server-side Web API, and what's called the access token in that article is called the "bootstrap access token."</span></span>

<span data-ttu-id="bb7e8-137">使用する言語とフレームワークによっては、記述する必要のあるサーバー側コードが簡単になるライブラリが使用できることがあります。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-137">Depending on your language and framework, libraries might be available that will simplify the server-side code you have to write.</span></span> <span data-ttu-id="bb7e8-138">コードでは、次に示す操作を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-138">Your code should do the following:</span></span>

* <span data-ttu-id="bb7e8-139">ブートストラップアクセストークン、ユーザーに関するメタデータ、およびアドインの資格情報 (ID とシークレット) を含む Azure AD v2.0 エンドポイントへの呼び出しを使用して、"代理" フローを開始します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-139">Initiate the "on behalf of" flow with a call to the Azure AD v2.0 endpoint that includes the bootstrap access token, some metadata about the user, and the credentials of the add-in (its ID and secret).</span></span>
* <span data-ttu-id="bb7e8-140">Microsoft Graph に (おそらくキャッシュされる) アクセス トークンを渡し、Microsoft Graph データを取得する 1 つ以上の Web API メソッドを作成します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-140">Create one or more Web API methods that get Microsoft Graph data by passing the (possibly cached) access token to Microsoft Graph.</span></span>
* <span data-ttu-id="bb7e8-141">必要に応じて、フローを開始する前に、以前に作成したトークン ハンドラーから受け取ったアドイン ブートストラップ アクセス トークンを検証します。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-141">Optionally, before initiating the flow, validate the add-in bootstrap access token that is received from the token handler you created earlier.</span></span> <span data-ttu-id="bb7e8-142">詳細については、[アクセス トークンの検証](sso-in-office-add-ins.md#validate-the-access-token)に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-142">For more information, see [Validate the access token](sso-in-office-add-ins.md#validate-the-access-token).</span></span> 
* <span data-ttu-id="bb7e8-143">必要に応じて、フローが完了した後に、Microsoft Graph のアクセス トークンをキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-143">Optionally, after the flow completes, cache the returned access token to Microsoft Graph.</span></span> <span data-ttu-id="bb7e8-144">アドインで Microsoft Graph を複数回呼び出す場合に、これが行われます。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-144">You'll want to do this if the add-in makes more than one call to Microsoft Graph.</span></span> <span data-ttu-id="bb7e8-145">このフローの詳細については、「[Azure Active Directory v2.0 と OAuth 2.0 の On-Behalf-Of フロー](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-145">For more information about this flow see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>

> [!NOTE]
> <span data-ttu-id="bb7e8-146">“代理” フローで取得した Microsoft Graph のデコードされたアクセス トークンの例については、「[Azure Active Directory v2.0 と OAuth 2.0 の On-Behalf-Of フロー](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-146">For examples of decoded access tokens for Microsoft Graph that have been obtained by the "on-behalf-of" flow, see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>

<span data-ttu-id="bb7e8-147">詳細なチュートリアルとシナリオについては、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="bb7e8-147">For examples of detailed walkthroughs and scenarios, see:</span></span>

* [<span data-ttu-id="bb7e8-148">シングル サインオンを使用する Node.js Office アドインを作成する</span><span class="sxs-lookup"><span data-stu-id="bb7e8-148">Create a Node.js Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-nodejs.md)
* [<span data-ttu-id="bb7e8-149">シングル サインオンを使用する ASP.NET Office アドインを作成する</span><span class="sxs-lookup"><span data-stu-id="bb7e8-149">Create an ASP.NET Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-aspnet.md)
* [<span data-ttu-id="bb7e8-150">シナリオ: Outlook アドインでサービスにシングル サインオンを実装する</span><span class="sxs-lookup"><span data-stu-id="bb7e8-150">Scenario: Implement single sign-on to your service in an Outlook add-in</span></span>](../outlook/implement-sso-in-outlook-add-in.md)
