---
title: Office アドインで Microsoft Graph へ承認する
description: ''
ms.date: 04/10/2018
ms.openlocfilehash: 83a9dd0beda9cb17a4f404c32cbe08a1e07f277e
ms.sourcegitcommit: 30435939ab8b8504c3dbfc62fd29ec6b0f1a7d22
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/12/2018
ms.locfileid: "23944300"
---
# <a name="authorize-to-microsoft-graph-in-your-office-add-in-preview"></a><span data-ttu-id="b077f-102">Office アドインで  Microsoft Graph へ承認（プレビュー）</span><span class="sxs-lookup"><span data-stu-id="b077f-102">Authorize to Microsoft Graph in your Office Add-in (preview)</span></span>

<span data-ttu-id="b077f-p101">ユーザーは個人用の Microsoft アカウントまたは職場や学校の (Office 365) アカウントのいずれかを使用して、Office (オンライン、モバイル、およびデスクトップ プラットフォーム) にサインインします。Office アドインで[ Microsoft Graph](https://developer.microsoft.com/graph/docs) への承認されたアクセス権を取得するには、ユーザーの office サインオンの資格情報を使用するのが最善の方法です。これにより、もう一度サインインすることがなく、Microsoft Graph のデータにアクセスすることができます。</span><span class="sxs-lookup"><span data-stu-id="b077f-p101">Users sign in to Office (online, mobile, and desktop platforms) using either their personal Microsoft account or their work or school (Office 365) account. The best way for an Office add-in to get authorized access to [Microsoft Graph](https://developer.microsoft.com/graph/docs) is to use the credentials from the user's Office sign on. This enables them to access their Microsoft Graph data without needing to sign in a second time.</span></span> 

> [!NOTE]
> <span data-ttu-id="b077f-106">現在、シングル サインオン API は Word、Excel、Outlook、PowerPoint のプレビューでサポートされています。</span><span class="sxs-lookup"><span data-stu-id="b077f-106">The Single Sign-on API is currently supported in preview for Word, Excel, Outlook, and PowerPoint.</span></span> <span data-ttu-id="b077f-107">シングル サインオン API の現在のサポート状態に関する詳細は、「[IdentityAPI の要件セット](https://docs.microsoft.com/javascript/office/requirement-sets/identity-api-requirement-sets?view=office-js)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b077f-107">For more information about where the Single Sign-on API is currently supported, see [IdentityAPI requirement sets](https://docs.microsoft.com/javascript/office/requirement-sets/identity-api-requirement-sets?view=office-js).</span></span>
> <span data-ttu-id="b077f-108">Outlook アドインで作業している場合は、Office 365 テナントの先進認証が有効になっていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="b077f-108">If you are working with an Outlook add-in, be sure to enable Modern Authentication for the Office 365 tenancy.</span></span> <span data-ttu-id="b077f-109">この方法の詳細については、「[Exchange Online: テナントの先進認証を有効にする方法](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b077f-109">For information about how to do this, see [Exchange Online: How to enable your tenant for modern authentication](https://social.technet.microsoft.com/wiki/contents/articles/32711.exchange-online-how-to-enable-your-tenant-for-modern-authentication.aspx).</span></span>

## <a name="add-in-architecture-for-sso-and-microsoft-graph"></a><span data-ttu-id="b077f-110">SSO と Microsoft Graph のアドイン アーキテクチャ</span><span class="sxs-lookup"><span data-stu-id="b077f-110">Add-in architecture for SSO and Microsoft Graph</span></span>

<span data-ttu-id="b077f-111">Web アプリケーションのページと JavaScript をホスティングすることに加え、アドインでは、同一の[完全修飾ドメイン名](https://docs.microsoft.com/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly)で、Microsoft Graph へのアクセス トークンを取得して、要求を送信するための 1 つ以上の Web API をホストする必要もあります。</span><span class="sxs-lookup"><span data-stu-id="b077f-111">In addition to hosting the pages and JavaScript of the web application, the add-in must also host, at the same [fully qualified domain name](https://docs.microsoft.com/windows/desktop/DNS/f-gly#_dns_fully_qualified_domain_name_fqdn__gly), one or more web APIs that will get an access token to Microsoft Graph and make requests to it.</span></span>

<span data-ttu-id="b077f-112">アドイン マニフェストには、アドインを Azure Active Directory (Azure AD) v2.0 エンドポイントに登録する方法と、アドインが必要とする Microsoft Graph へのアクセス許可を指定するマークアップが含まれています。</span><span class="sxs-lookup"><span data-stu-id="b077f-112">The add-in manifest contains markup that specifies how the add-in is registered in the Azure Active Directory (Azure AD) v2.0 endpoint, and it specifies any permissions to Microsoft Graph that the add-in needs.</span></span>

### <a name="how-it-works-at-runtime"></a><span data-ttu-id="b077f-113">実行時の動作のしくみ</span><span class="sxs-lookup"><span data-stu-id="b077f-113">How it works at runtime</span></span>

<span data-ttu-id="b077f-114">次の図は、サインインして Microsoft Graph にアクセスするプロセスを示しています。</span><span class="sxs-lookup"><span data-stu-id="b077f-114">The following diagram shows how the process of signing in and getting access to Microsoft Graph works.</span></span>

![SSO プロセスを示す図](../images/sso-access-to-microsoft-graph.png)

1. <span data-ttu-id="b077f-116">アドインでは、JavaScript は新しい Office.js API [getAccessTokenAsync](https://docs.microsoft.com/office/dev/add-ins/develop/sso-in-office-add-ins#sso-api-reference) を呼び出します。</span><span class="sxs-lookup"><span data-stu-id="b077f-116">In the add-in, JavaScript calls a new Office.js API [](https://docs.microsoft.com/office/dev/add-ins/develop/sso-in-office-add-ins#sso-api-reference).</span></span> <span data-ttu-id="b077f-117">これにより、Office ホスト アプリケーションにアドインへのアクセス トークンを取得するように指示します。</span><span class="sxs-lookup"><span data-stu-id="b077f-117">This tells the Office host application to obtain an access token to the add-in.</span></span> <span data-ttu-id="b077f-118">（後の手順で 2 番目のトークンに置き換えられるため、以下、これを **ブートストラップ アクセス トークン** と呼びます。</span><span class="sxs-lookup"><span data-stu-id="b077f-118">(Hereafter, this is called the **bootstrap access token** because it is replaced with a second token later in the process.</span></span> <span data-ttu-id="b077f-119">デコードされたブートストラップ アクセス トークンの例については、「[アクセストークンの例](sso-in-office-add-ins.md#example-access-token)」を参照してください。）</span><span class="sxs-lookup"><span data-stu-id="b077f-119">For an example of a decoded bootstrap access token, see [Example access token](sso-in-office-add-ins.md#example-access-token).)</span></span>
1. <span data-ttu-id="b077f-120">ユーザーがサインインしていない場合、Office ホスト アプリケーションはユーザーにサインインを求めるポップアップ ウィンドウを開きます。</span><span class="sxs-lookup"><span data-stu-id="b077f-120">If the user is not signed in, the Office host application opens a pop-up window for the user to sign in.</span></span>
1. <span data-ttu-id="b077f-121">現在のユーザーが初めてアドインを使用する場合は、そのユーザーに同意を求めるダイアログを表示します。</span><span class="sxs-lookup"><span data-stu-id="b077f-121">If this is the first time the current user has used your add-in, he or she is prompted to consent.</span></span>
1. <span data-ttu-id="b077f-122">Office ホスト アプリケーションは、現在のユーザーについて Azure AD v2.0 エンドポイントから**ブートストラップ アクセス トークン** を要求します。</span><span class="sxs-lookup"><span data-stu-id="b077f-122">The Office host application requests the **add-in token** from the Azure AD v2.0 endpoint for the current user.</span></span>
1. <span data-ttu-id="b077f-123">Azure AD は、Office ホスト アプリケーションにブートストラップ トークンを送信します。</span><span class="sxs-lookup"><span data-stu-id="b077f-123">Azure AD sends the add-in token to the Office host application.</span></span>
1. <span data-ttu-id="b077f-124">Office ホスト アプリケーションは、\*\* \*\*  呼び出しによって返される結果オブジェクトの一部として、アドインに `getAccessTokenAsync` ブートストラップ アクセス トークン を送信します。</span><span class="sxs-lookup"><span data-stu-id="b077f-124">The Office host application sends the **add-in token** to the add-in as part of the result object returned by the `getAccessTokenAsync` call.</span></span>
1. <span data-ttu-id="b077f-125">アドインの JavaScript は、アドインと同じ完全修飾ドメインでホストされている Web API に HTTP 要求を送信し、その要求に承認の証拠として **ブートストラップ アクセス トークン** を含めます。</span><span class="sxs-lookup"><span data-stu-id="b077f-125">JavaScript in the add-in makes an HTTP request to a web API that is hosted at the same fully-qualified domain as the add-in, and it includes the **add-in token** as authorization proof.</span></span>  
1. <span data-ttu-id="b077f-126">サーバー側のコードは、受信した **ブートストラップ アクセス トークン**を検証します。</span><span class="sxs-lookup"><span data-stu-id="b077f-126">Server-side code validates the incoming **add-in token**.</span></span>
1. <span data-ttu-id="b077f-127">サーバー側のコードでは、 "On-Behalf-Of" フロー（「[ OAuth トークン交換](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) 」および「[ デーモンまたはサーバー アプリケーション 対 Web API Azure シナリオ](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios#daemon-or-server-application-to-web-api)」 で定義されたもの）を使用して、ブートストラップ アクセストークンと引き換えに Microsoft Graph のアクセストークンを取得します。</span><span class="sxs-lookup"><span data-stu-id="b077f-127">Server-side code uses the “on behalf of” flow (defined at [OAuth2 Token Exchange](https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-02) and the [daemon or server application to web API Azure scenario](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios#daemon-or-server-application-to-web-api)) to obtain an access token for Microsoft Graph (hereafter, the "MSG token") in exchange for the add-in token.</span></span>
1. <span data-ttu-id="b077f-128">Azure AD は、アドインに Microsoft Graph へのアクセス トークン (アドインが *offline_access* アクセス許可を要求した場合は、更新トークンも) を返します。</span><span class="sxs-lookup"><span data-stu-id="b077f-128">Azure AD returns the MSG token (and a refresh token, if the add-in requests offline_access permission) to the add-in.</span></span>
1. <span data-ttu-id="b077f-129">サーバー側のコードは、アクセストークンを Microsoft Graph にキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="b077f-129">Server-side code caches the access token to Microsoft Graph.</span></span>
1. <span data-ttu-id="b077f-130">サーバー側のコードは Microsoft Graph への要求を行い、Microsoft Graph へのアクセス トークンを含みます。</span><span class="sxs-lookup"><span data-stu-id="b077f-130">Server-side code makes requests to Microsoft Graph and includes the MSG token.</span></span>
1. <span data-ttu-id="b077f-131">Microsoft Graph は、アドインの UI に渡すことができるデータをアドインに返します。</span><span class="sxs-lookup"><span data-stu-id="b077f-131">Microsoft Graph returns data to the add-in, which can pass it on to the add-in’s UI.</span></span>
1. <span data-ttu-id="b077f-132">Microsoft Graph へのアクセストークンが期限切れになると、サーバー側のコードは更新トークンを使用して Microsoft Graph への新しいアクセストークンを取得できます。</span><span class="sxs-lookup"><span data-stu-id="b077f-132">When the access token to Microsoft Graph expires, the server-side code can use its refresh token to get a new access token to Microsoft Graph.</span></span>

## <a name="develop-an-sso-add-in-that-accesses-microsoft-graph"></a><span data-ttu-id="b077f-133">Microsoft Graph にアクセスする SSO アドインの開発</span><span class="sxs-lookup"><span data-stu-id="b077f-133">Develop an SSO add-in that accesses Microsoft Graph</span></span>

<span data-ttu-id="b077f-134">SSO を使用する他のアドインと同様に、Microsoft Graphにアクセスするアドインを開発します。</span><span class="sxs-lookup"><span data-stu-id="b077f-134">You develop an add-in that accesses Microsoft Graph just as you would any other add-in that uses SSO.</span></span> <span data-ttu-id="b077f-135">詳細な説明については、 [Officeアドインのシングル サインオンを有効にする](https://docs.microsoft.com/office/dev/add-ins/develop/sso-in-office-add-ins)を参照してください。違いは、アドインにはサーバー側の Web API が必須であり、その記事ではアクセス トークンと呼ばれるものを「ブートストラップ アクセス トークン」と呼びます。</span><span class="sxs-lookup"><span data-stu-id="b077f-135">For a thorough description, see [Enable single sign-on for Office Add-ins](https://docs.microsoft.com/office/dev/add-ins/develop/sso-in-office-add-ins). The difference is that it is mandatory that the add-in have a server-side Web API, and what's called the access token in that article is called the "bootstrap access token."</span></span> 

<span data-ttu-id="b077f-136">使用する言語とフレームワークによっては、記述が必要なサーバー側コードを単純化することが可能なライブラリを使用できる場合があります。</span><span class="sxs-lookup"><span data-stu-id="b077f-136">Depending on your language and framework, libraries might be available that will simplify the code you have to write.</span></span> <span data-ttu-id="b077f-137">コードでは次のことを行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="b077f-137">Your server-side code should do the following:</span></span>

* <span data-ttu-id="b077f-138">前の手順で作成したトークン ハンドラーから受け取ったアドイン ブートストラップ アクセス トークンを検証します。</span><span class="sxs-lookup"><span data-stu-id="b077f-138">Validate the add-in token that is received from the token handler you created earlier.</span></span> <span data-ttu-id="b077f-139">詳細については、「[アクセス トークンを検証する](sso-in-office-add-ins.md#validate-the-access-token)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b077f-139">For more information, see [Validate the access token](sso-in-office-add-ins.md#validate-the-access-token).</span></span> 
* <span data-ttu-id="b077f-140">ブートストラップ アクセス トークン、ユーザーに関するメタデータ、アドインの認証情報 (ID と秘匿情報) を含む Azure AD v2.0 エンドポイントへの呼び出しを使用して 「On-Behalf-Of」 フローを開始します。</span><span class="sxs-lookup"><span data-stu-id="b077f-140">Initiate the “on behalf of” flow with a call to the Azure AD v2.0 endpoint that includes the add-in access token, some metadata about the user, and the credentials of the add-in (its ID and secret).</span></span>
* <span data-ttu-id="b077f-141">返されたアクセス トークンを Microsoft Graph にキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="b077f-141">Use the access token to call Microsoft Graph.</span></span> <span data-ttu-id="b077f-142">このフローの詳細については、「[Azure Active Directory v2.0 および OAuth 2.0 On-Behalf-Of フロー](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b077f-142">For more information about this flow see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>
* <span data-ttu-id="b077f-143">キャッシュされた アクセス トークン を Microsoft Graph に渡すことで Microsoft Graph データを取得する、 1 つ以上のWeb APIメソッドを作成します。</span><span class="sxs-lookup"><span data-stu-id="b077f-143">Create one or more Web API methods that get Microsoft Graph data by passing the cached access token to Microsoft Graph.</span></span>

> [!NOTE]
> <span data-ttu-id="b077f-144">「On-Behalf-Of」 フローで取得した Microsoft Graph のデコードされたアクセス トークンの例については、「[Azure Active Dictionary v2.0 および OAuth 2.0 On-Behalf-Of フロー](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of) 」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b077f-144">For examples of decoded access tokens for Microsoft Graph that have been obtained by the "on-behalf-of" flow, see [Azure Active Directory v2.0 and OAuth 2.0 On-Behalf-Of flow](https://docs.microsoft.com/azure/active-directory/develop/active-directory-v2-protocols-oauth-on-behalf-of).</span></span>

<span data-ttu-id="b077f-145">詳細なウォークスルーとシナリオの例については、次を参照してください。</span><span class="sxs-lookup"><span data-stu-id="b077f-145">For examples of detailed walkthroughs, see:</span></span>

* [<span data-ttu-id="b077f-146">シングル サインオンを使用する Node.js Office アドインを作成する</span><span class="sxs-lookup"><span data-stu-id="b077f-146">Create a Node.js Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-nodejs.md)
* [<span data-ttu-id="b077f-147">シングル サインオンを使用する ASP.NET Office アドインを作成する</span><span class="sxs-lookup"><span data-stu-id="b077f-147">Create an ASP.NET Office Add-in that uses single sign-on</span></span>](create-sso-office-add-ins-aspnet.md)
* [<span data-ttu-id="b077f-148">シナリオ: Outlook アドインでサービスにシングル サインオンを実装する</span><span class="sxs-lookup"><span data-stu-id="b077f-148">Scenario: Implement single sign-on to your service in an Outlook Add-in</span></span>](https://docs.microsoft.com/outlook/add-ins/implement-sso-in-outlook-add-in)



